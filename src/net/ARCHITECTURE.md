# Net 模块整体架构文档

## 5.1 Net 模块整体架构

### 概述

Net 模块是 MementoDB 的网络服务层，负责处理客户端连接、协议解析、请求路由和响应。采用事件驱动架构，支持高并发、高性能的网络通信。

### 架构设计原则

1. **事件驱动**：基于 IOLoop 的事件循环机制
2. **异步非阻塞**：使用 epoll/kqueue 等高效 IO 多路复用
3. **分层设计**：清晰的层次结构，职责分离
4. **可扩展性**：支持多协议、多监听端口
5. **线程安全**：支持多线程环境下的并发访问

---

## 核心组件架构

### 1. Server（服务器主类）

**职责**：
- 整合所有网络组件
- 管理服务器生命周期（启动/停止/重启）
- 监听端口和接受连接
- 协调各组件工作

**关键特性**：
- 支持多个监听端点（多端口、多协议）
- 连接管理和限流
- 统计信息和监控
- 健康检查
- 优雅关闭

**依赖关系**：
```
Server
├── IOLoop (IO事件循环)
├── ConnectionManager (连接管理器)
├── ThreadPool (业务线程池)
└── Protocol (协议解析器)
```

### 2. IOLoop（IO事件循环抽象）

**职责**：
- 提供统一的 IO 事件循环接口
- 管理文件描述符事件（读/写/错误）
- 定时器管理
- 异步任务调度

**实现**：
- `EpollLoop`：Linux epoll 实现
- 可扩展支持 kqueue（macOS/FreeBSD）、select、IOCP（Windows）

**关键接口**：
```cpp
- add_fd()          // 注册文件描述符
- modify_fd()       // 修改关注的事件
- remove_fd()       // 移除文件描述符
- add_timer()       // 添加定时器
- run()             // 运行事件循环
- run_once()        // 运行一次循环
```

### 3. EpollLoop（Linux epoll 实现）

**职责**：
- Linux 平台的高性能 IO 多路复用实现
- 基于 epoll 的事件驱动机制

**优势**：
- O(1) 时间复杂度的事件通知
- 支持边缘触发（ET）和水平触发（LT）
- 适合高并发场景

### 4. Connection（连接处理）

**职责**：
- 管理单个客户端连接的生命周期
- 接收和发送数据
- 协议解析和命令处理
- 连接状态管理

**状态机**：
```
CONNECTED → AUTHENTICATING → PROCESSING → CLOSING → CLOSED
```

**关键功能**：
- 数据接收和缓冲
- 命令解析和执行
- 响应发送
- 连接统计
- 超时管理
- 认证支持

**依赖关系**：
```
Connection
├── Protocol (协议解析)
├── DiskEngineV2 (存储引擎)
└── ConnectionManager (连接管理器)
```

### 5. Protocol（协议解析器）

**职责**：
- 解析 Redis RESP2/RESP3 协议
- 流式解析支持
- 管道和事务支持
- 响应构建

**支持的协议特性**：
- RESP2：简单字符串、错误、整数、批量字符串、数组
- RESP3：布尔值、双精度、大数、映射、集合等扩展类型
- 管道（Pipeline）：批量命令
- 事务（Transaction）：MULTI/EXEC/DISCARD

**关键方法**：
```cpp
- parse_request()        // 解析单个请求
- parse_pipeline()       // 解析管道请求
- parse_stream()         // 流式解析
- build_*()              // 构建各种响应类型
```

### 6. ThreadPool（线程池）

**职责**：
- 管理业务处理线程
- 任务队列管理
- 任务调度和执行
- 线程池统计

**特性**：
- 动态线程数调整
- 任务优先级支持
- 任务超时控制
- 线程池监控

---

## 数据流架构

### 请求处理流程

```
客户端连接
    ↓
Server::on_accept() 接受连接
    ↓
ConnectionManager::add_connection() 创建连接
    ↓
IOLoop::add_fd() 注册到事件循环
    ↓
[事件循环] 检测到读事件
    ↓
Connection::on_data_received() 接收数据
    ↓
Protocol::parse_stream() 解析协议
    ↓
Connection::process_command() 处理命令
    ↓
ThreadPool::submit() 提交到线程池（可选）
    ↓
DiskEngineV2::get/put/remove() 执行数据库操作
    ↓
Connection::send() 发送响应
    ↓
IOLoop 检测到写事件
    ↓
发送数据到客户端
```

### 响应构建流程

```
命令执行结果
    ↓
Protocol::build_*() 构建 RESP 响应
    ↓
Connection::send() 添加到发送队列
    ↓
IOLoop 检测到写事件
    ↓
Connection::flush_write_buffer() 刷新缓冲区
    ↓
发送到客户端
```

---

## 线程模型

### IO 线程（主线程）

- 运行 IOLoop 事件循环
- 处理网络 IO（accept、read、write）
- 管理连接生命周期
- 轻量级操作（协议解析、响应构建）

### 工作线程池（ThreadPool）

- 执行耗时操作（数据库查询、复杂计算）
- 异步任务处理
- 可配置线程数量

### 线程安全设计

- Connection：使用 mutex 保护共享状态
- Server：使用 shared_mutex 支持并发读取
- ThreadPool：使用条件变量和锁管理任务队列

---

## 配置系统

### ServerConfig（服务器配置）

```cpp
struct ServerConfig {
    // 监听配置（支持多个端点）
    std::vector<ListenConfig> listen_configs;
    
    // 协议配置
    ProtocolConfig protocol_config;
    
    // 连接配置
    ConnectionConfig connection_config;
    
    // 线程配置
    ThreadConfig thread_config;
    
    // 性能配置
    PerformanceConfig performance_config;
    
    // 安全配置
    SecurityConfig security_config;
    
    // 监控配置
    MonitorConfig monitor_config;
};
```

### 关键配置项

- **监听配置**：host、port、backlog、TCP选项
- **连接配置**：最大连接数、超时时间、缓冲区大小
- **线程配置**：IO线程数、工作线程数、队列大小
- **性能配置**：TCP_NODELAY、TCP_DEFER_ACCEPT、epoll参数

---

## 监控和统计

### Server 统计信息

- 连接统计：总数、活跃数、峰值、拒绝数
- 请求统计：总数、QPS、峰值QPS、失败数
- 网络统计：接收/发送字节数、错误数
- 命令统计：各命令执行次数、慢查询
- 系统资源：CPU、内存、文件描述符

### Connection 统计信息

- 接收/发送字节数
- 处理的命令数
- 错误数
- 连接时长

### IOLoop 统计信息

- 注册的文件描述符数
- 处理的事件数
- 循环次数和耗时
- 定时器数量

---

## 错误处理

### 错误类型

1. **网络错误**：连接断开、超时、IO错误
2. **协议错误**：格式错误、参数错误
3. **业务错误**：命令不存在、参数错误
4. **系统错误**：资源不足、权限错误

### 错误处理机制

- 异常捕获和转换
- 错误响应构建（RESP错误格式）
- 连接关闭和清理
- 日志记录

---

## 扩展性设计

### 协议扩展

- 支持自定义协议解析器
- 协议版本协商（RESP2 ↔ RESP3）
- 协议升级机制

### 连接扩展

- 自定义连接工厂
- 连接过滤器（IP白名单/黑名单）
- 连接中间件支持

### 命令扩展

- 自定义命令处理器
- 命令验证器注册
- 命令别名支持

---

## 性能优化

### IO 优化

- 使用 epoll 高效事件通知
- 零拷贝技术（sendfile、splice）
- 批量IO操作
- 缓冲区优化

### 协议优化

- 流式解析减少内存拷贝
- 管道批量处理
- 响应压缩（可选）

### 线程优化

- IO线程和工作线程分离
- 避免线程切换开销
- 无锁数据结构（where possible）

---

## 依赖关系图

### 组件依赖关系

```
                    ┌─────────────┐
                    │   Server    │  (主控制器)
                    │             │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
   ┌─────────┐      ┌──────────────┐   ┌─────────────┐
   │ IOLoop  │      │ Connection   │   │ ThreadPool  │
   │(Epoll)  │◄─────┤  Manager    │   │             │
   │         │      │              │   │ (业务线程)  │
   └────┬────┘      └──────┬───────┘   └─────────────┘
        │                  │
        │                  ▼
        │            ┌─────────────┐
        │            │ Connection  │  (每个客户端一个)
        │            │             │
        │            └──────┬──────┘
        │                   │
        │                   ▼
        │            ┌─────────────┐
        │            │  Protocol  │  (RESP2/RESP3)
        │            │            │
        │            └──────┬──────┘
        │                   │
        └───────────────────┼──────────────┐
                            │              │
                            ▼              ▼
                    ┌──────────────┐  ┌──────────┐
                    │ DiskEngineV2 │  │  Utils   │
                    │  (存储引擎)  │  │ (工具类) │
                    └──────────────┘  └──────────┘
```

### 数据流向图

```
客户端请求流程：
┌─────────┐
│ Client  │
└────┬────┘
     │ TCP连接
     ▼
┌─────────────────────────────────────────┐
│           Server (监听端口)              │
│  ┌───────────────────────────────────┐  │
│  │  IOLoop (事件循环)                │  │
│  │  - epoll_wait() 等待事件          │  │
│  │  - 检测到新连接/数据可读           │  │
│  └───────────┬───────────────────────┘  │
│              │                           │
│              ▼                           │
│  ┌───────────────────────────────────┐  │
│  │  ConnectionManager                │  │
│  │  - 管理所有连接                    │  │
│  │  - 连接生命周期管理                │  │
│  └───────────┬───────────────────────┘  │
│              │                           │
│              ▼                           │
│  ┌───────────────────────────────────┐  │
│  │  Connection (单个连接)            │  │
│  │  - 接收数据                       │  │
│  │  - 调用 Protocol 解析             │  │
│  │  - 处理命令                       │  │
│  └───────────┬───────────────────────┘  │
└──────────────┼──────────────────────────┘
                │
                ▼
        ┌───────────────┐
        │   Protocol    │  (解析 RESP 协议)
        │  - parse()    │
        │  - build()    │
        └───────┬───────┘
                │
                ▼
        ┌───────────────┐
        │  ThreadPool   │  (可选：耗时操作)
        │  - submit()   │
        └───────┬───────┘
                │
                ▼
        ┌───────────────┐
        │ DiskEngineV2  │  (执行数据库操作)
        │  - get()      │
        │  - put()      │
        │  - remove()   │
        └───────┬───────┘
                │
                ▼ (响应)
        ┌───────────────┐
        │  Connection   │  (发送响应)
        │  - send()     │
        └───────┬───────┘
                │
                ▼
        ┌───────────────┐
        │  IOLoop       │  (检测写事件)
        │  - 发送数据   │
        └───────┬───────┘
                │
                ▼
        ┌───────────────┐
        │    Client     │  (接收响应)
        └───────────────┘
```

### 线程模型图

```
┌─────────────────────────────────────────────────────┐
│              IO 线程 (主线程)                       │
│  ┌──────────────────────────────────────────────┐  │
│  │  IOLoop::run()                               │  │
│  │  - epoll_wait() 等待事件                     │  │
│  │  - 处理网络 IO (accept/read/write)          │  │
│  │  - 协议解析 (轻量级)                         │  │
│  │  - 响应构建                                 │  │
│  └──────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
                        │
                        │ 提交耗时任务
                        ▼
┌─────────────────────────────────────────────────────┐
│           工作线程池 (ThreadPool)                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐         │
│  │ Worker 1 │  │ Worker 2 │  │ Worker N │         │
│  │          │  │          │  │          │         │
│  │ - 数据库 │  │ - 数据库 │  │ - 数据库 │         │
│  │   查询   │  │   查询   │  │   查询   │         │
│  │ - 复杂   │  │ - 复杂   │  │ - 复杂   │         │
│  │   计算   │  │   计算   │  │   计算   │         │
│  └──────────┘  └──────────┘  └──────────┘         │
└─────────────────────────────────────────────────────┘
```

---

## 文件结构

```
src/net/
├── Server.hpp/cpp          # 服务器主类
├── Connection.hpp/cpp       # 连接处理
├── Protocol.hpp/cpp        # 协议解析
├── IOLoop.hpp/cpp          # IO循环抽象
├── EpollLoop.hpp/cpp       # epoll实现
├── ThreadPool.hpp/cpp      # 线程池
└── tests/                  # 测试文件
    └── NetModuleTest.cpp   # 综合测试
```

---

## 使用示例

### 基本使用

```cpp
#include "net/Server.hpp"

// 创建存储引擎
auto engine = std::make_shared<core::DiskEngineV2>("./data", config);

// 创建服务器配置
net::ServerConfig server_config;
net::ServerConfig::ListenConfig listen_cfg;
listen_cfg.host = "0.0.0.0";
listen_cfg.port = 6379;
server_config.listen_configs.push_back(listen_cfg);

// 创建并启动服务器
auto server = net::Server::create(engine, server_config);
server->start();

// 运行服务器（阻塞）
server->run(true);

// 停止服务器
server->stop(true);
```

---

## 总结

Net 模块采用事件驱动、异步非阻塞的架构设计，通过分层和组件化的方式实现了高性能、高并发的网络服务。核心组件职责清晰，易于扩展和维护。

**关键优势**：
- ✅ 高性能：基于 epoll 的高效 IO 多路复用
- ✅ 高并发：支持大量并发连接
- ✅ 可扩展：支持多协议、多端口
- ✅ 易维护：清晰的架构和职责分离
- ✅ 线程安全：支持多线程环境

